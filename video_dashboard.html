<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <title>Arcade Video Dashboard</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <style>
            :root {
                --deep-purple: #360185;
                --magenta: #8F0177;
                --pink: #DE1A58;
                --gold: #F4B342;
                --bg: #0d011a;
                --glass: rgba(255, 255, 255, 0.05);
                --glass-border: rgba(255, 255, 255, 0.1);
            }

            body { margin: 0; padding: 0; background-color: var(--bg); color: #eee; font-family: 'Inter', system-ui, -apple-system, sans-serif; overflow-x: hidden; }

            /* --- STARFIELD BACKGROUND --- */
            #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); }

            /* --- ARCADE HEADER --- */
            .arcade-header {
                position: relative; width: 100%; height: 280px;
                background: linear-gradient(to bottom, var(--deep-purple), var(--magenta));
                overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;
                border-bottom: 5px solid var(--gold);
            }
            .grid-bg {
                position: absolute; bottom: 0; width: 100%; height: 100%;
                background-image: linear-gradient(transparent 0%, var(--pink) 2%, transparent 3%),
                                  linear-gradient(90deg, transparent 0%, var(--pink) 2%, transparent 3%);
                background-size: 50px 50px; perspective: 200px; transform: rotateX(60deg) scale(2);
                transform-origin: bottom; opacity: 0.3; animation: moveGrid 2s linear infinite;
            }
            @keyframes moveGrid { 0% { background-position: 0 0; } 100% { background-position: 0 50px; } }

            .scanlines {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
                background-size: 100% 4px; z-index: 2; pointer-events: none;
            }

            /* --- LOGO --- */
            .logo-container { position: relative; z-index: 3; filter: drop-shadow(0 0 15px var(--gold)); }
            .video-scanner-text {
                font-family: 'Arial Black', sans-serif; font-weight: 900;
                text-transform: uppercase; font-size: 85px; letter-spacing: 3px;
            }

            .glitch-wrapper { animation: glitch 4s infinite; }
            @keyframes glitch {
                0% { transform: translate(0); }
                1% { transform: translate(-5px, 2px); filter: hue-rotate(90deg); }
                2% { transform: translate(5px, -2px); filter: hue-rotate(180deg); }
                3% { transform: translate(0); filter: none; }
                100% { transform: translate(0); }
            }

            .stats-display {
                position: absolute; bottom: 15px; right: 20px; z-index: 10;
                background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px;
                border: 1px solid var(--gold); font-family: 'SF Mono', monospace;
                color: var(--gold); text-transform: uppercase; font-size: 0.8rem; box-shadow: 0 0 10px var(--gold);
            }

            /* --- DASHBOARD UI --- */
            .top-bar {
                position: sticky; top: 0; background: rgba(13, 1, 26, 0.85);
                backdrop-filter: blur(20px); z-index: 5000; padding: 15px 0;
                border-bottom: 1px solid var(--glass-border);
            }
            .container { max-width: 1400px; margin: auto; padding: 0 20px; }
            .controls { display: flex; gap: 15px; align-items: center; }
            #searchBar { background: var(--glass); border: 1px solid var(--glass-border); color: white; padding: 12px 20px; border-radius: 12px; width: 300px; outline: none; }
            #searchBar:focus { border-color: var(--pink); box-shadow: 0 0 10px var(--pink); }

            .filter-btn {
                background: var(--glass); border: 1px solid var(--glass-border); color: #ccc;
                padding: 10px 18px; border-radius: 10px; cursor: pointer; transition: 0.2s;
                display: flex; align-items: center; gap: 8px; font-weight: 500; font-family: inherit;
            }
            .filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
            .filter-btn.active { background: var(--pink); color: white; border-color: transparent; box-shadow: 0 0 15px rgba(222, 26, 88, 0.4); }

            #codecSelect, #sortSelect {
                background: var(--glass); border: 1px solid var(--glass-border); color: #ccc;
                padding: 10px 18px; border-radius: 10px; cursor: pointer; outline: none;
                font-family: inherit; font-size: 0.9rem; transition: 0.2s; height: 42px;
            }
            #codecSelect:hover, #sortSelect:hover { background: rgba(255,255,255,0.1); color: white; }
            #codecSelect option, #sortSelect option { background: #1a012a; color: white; }

            /* --- QUICK ACTIONS OVERLAY --- */
            .quick-actions-overlay {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
                gap: 20px; opacity: 0; transition: 0.3s; z-index: 50;
            }
            .card-media:hover .quick-actions-overlay { opacity: 1; }
            .quick-action-btn {
                width: 45px; height: 45px; border-radius: 50%; background: var(--pink);
                color: white; display: flex; align-items: center; justify-content: center;
                text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s;
                transform: translateY(20px);
            }
            .card-media:hover .quick-action-btn { transform: translateY(0); }
            .quick-action-btn:hover { transform: scale(1.1) !important; background: var(--gold); color: #000; }
            .quick-action-btn.active { background: var(--gold); color: #000; }

            /* --- CINEMA MODE MODAL --- */
            #cinemaModal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.95); backdrop-filter: blur(15px);
                z-index: 10000; display: none; align-items: center; justify-content: center;
                flex-direction: column;
            }
            #cinemaModal.active { display: flex; }
            #cinemaVideo { width: 85%; max-height: 80vh; border: 2px solid var(--glass-border); border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
            .cinema-close { position: absolute; top: 30px; right: 40px; color: white; cursor: pointer; font-size: 40px; z-index: 10001; transition: 0.3s; }
            .cinema-close:hover { color: var(--pink); transform: rotate(90deg); }
            .cinema-title { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); color: var(--gold); font-weight: bold; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }

            /* --- SCROLLBAR --- */
            ::-webkit-scrollbar { width: 10px; }
            ::-webkit-scrollbar-track { background: var(--bg); }
            ::-webkit-scrollbar-thumb { background: var(--magenta); border-radius: 5px; border: 2px solid var(--bg); }
            ::-webkit-scrollbar-thumb:hover { background: var(--pink); }

            /* --- LAYOUTS --- */
            #videoGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; padding: 30px 0; }
            #videoGrid.list-view { display: flex; flex-direction: column; gap: 15px; }

            .content-card {
                background: var(--glass); border-radius: 16px; border: 1px solid var(--glass-border);
                transition: 0.4s cubic-bezier(0.2, 1, 0.2, 1); overflow: hidden; position: relative; backdrop-filter: blur(10px);
                display: flex; flex-direction: column;
            }
            .content-card:hover { transform: translateY(-5px); border-color: var(--pink); box-shadow: 0 10px 30px rgba(222, 26, 88, 0.2); background: rgba(255,255,255,0.08); }

            .card-media { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; }
            .thumb { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
            .preview-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
            .content-card:hover .preview-video { opacity: 1; }

            .card-body { padding: 15px; flex-grow: 1; }
            .file-name { color: #fff; font-weight: bold; font-size: 1rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
            .file-dir { color: #aaa; font-family: 'SF Mono', monospace; font-size: 0.7rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.6; }

            .card-footer { padding: 12px 15px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
            .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
            .badge.high { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); }
            .badge.ok { background: #1b3a1b; color: #4cd964; border: 1px solid #2e7d32; box-shadow: 0 0 5px #2e7d32; }
            .badge.hevc { background: #1a3a3a; color: #00ffd0; border: 1px solid #00ffd055; margin-left: 8px; }

            .btn.done { color: var(--gold); }

            /* --- ARCHIVE STYLING --- */
            .video-card-container[data-hidden="true"] .content-card {
                filter: grayscale(0.8) contrast(0.8);
                opacity: 0.5;
                border-style: dashed;
            }
            .video-card-container[data-hidden="true"]:hover .content-card {
                filter: grayscale(0.2) contrast(1);
                opacity: 0.9;
            }
            .archive-badge {
                position: absolute; top: 10px; left: 10px; z-index: 100;
                background: #000; color: #fff; padding: 4px 10px; border-radius: 4px;
                font-size: 0.6rem; font-weight: bold; border: 1px solid #444;
                display: none;
            }
            .video-card-container[data-hidden="true"] .archive-badge { display: block; }

            .selection-bar {
                position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
                background: var(--magenta); color: white; padding: 15px 30px; border-radius: 50px;
                display: flex; gap: 20px; align-items: center; z-index: 9999;
                box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 2px solid var(--gold);
                transition: transform 0.4s cubic-bezier(0.2, 1, 0.2, 1);
            }
            .selection-bar.active { transform: translateX(-50%) translateY(0); }
</style>
    </head>
    <body data-port="8002">
        <canvas id="starfield"></canvas>
        <div class="scanlines"></div>
        
        <header class="arcade-header">
            <div class="grid-bg"></div>
            <div class="logo-container">
                <div class="glitch-wrapper">
                    <h1 class="video-scanner-text">ARCADE 4.0</h1>
                </div>
            </div>
            <div class="stats-display">
                STATUS: READY // 
                TOTAL: <span id="count-total">0</span> VIDEOS // 
                VOLUME: <span id="size-total">0.0 GB</span>
            </div>
        </header>

        <div class="top-bar">
            <div class="container controls">
                <input type="text" id="searchBar" placeholder="Suchen..." oninput="filterAndSort()">
                
                <button class="filter-btn active" id="f-all" onclick="setFilter('all')">ALL</button>
                <button class="filter-btn" id="f-HIGH" onclick="setFilter('HIGH')">ðŸš¨ HIGH BITRATE</button>
                <button class="filter-btn" id="f-OK" onclick="setFilter('OK')">âœ… OPTIMIZED</button>
                
                <select id="codecSelect" onchange="setCodecFilter(this.value)">
                    <option value="all">Alle Codecs</option>
                    <option value="h264">H.264 / AVC</option>
                    <option value="hevc">H.265 / HEVC</option>
                </select>

                <select id="sortSelect" onchange="setSort(this.value)">
                    <option value="bitrate">Sort: Bitrate</option>
                    <option value="size">Sort: DateigrÃ¶ÃŸe</option>
                    <option value="name">Sort: Name (A-Z)</option>
                </select>

                <button class="filter-btn" id="toggleView" onclick="toggleLayout()"><span class="material-icons">view_list</span> List View</button>
                
                <div style="width:2px; height:24px; background:var(--glass-border); margin:0 10px;"></div>
                
                <button class="filter-btn" id="f-hidden" onclick="toggleShowHidden()">
                    <span class="material-icons">visibility_off</span> Archiv zeigen
                </button>
                
                <a href="javascript:location.reload()" style="margin-left:auto;" class="filter-btn">ðŸ”„ Refresh</a>
            </div>
        </div>

        <div class="container">
            <div id="videoGrid">
            </div>
        </div>
        
        <div id="cinemaModal">
            <span class="cinema-close" onclick="closeCinema()">&times;</span>
            <span id="cinemaTitle" class="cinema-title">MOVIE PLAYER</span>
            <video id="cinemaVideo" controls preload="metadata"></video>
        </div>
        
        <div id="batchBar" class="selection-bar">
            <span><strong id="batchCount">0</strong> Videos ausgewÃ¤hlt</span>
            <button class="filter-btn active" onclick="triggerBatchCompress()">
                <span class="material-icons">bolt</span> OPTIMIEREN
            </button>
            <button class="filter-btn" onclick="triggerBatchHide(true)" style="background:var(--deep-purple); border-color:var(--glass-border);">
                <span class="material-icons">visibility_off</span> ALS GELESEN MARKIEREN
            </button>
            <button class="filter-btn" onclick="clearSelection()" style="background:transparent; border-color:white;">
                Abbrechen
            </button>
        </div>
        
        <iframe name='h_frame' style='display:none;'></iframe>

        <script>
            window.SERVER_PORT = 8002;
            
            let currentFilter = 'all';
            let currentCodec = 'all';
            let currentSort = 'bitrate';
            let currentLayout = 'grid'; // grid or list
            let showHidden = false;

            // --- STARFIELD ---
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            let stars = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
            window.onresize = resize; resize();

            for(let i=0; i<200; i++) {
                stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2, speed: Math.random()*0.5 + 0.1 });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                stars.forEach(s => {
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
                    ctx.fill();
                    s.y += s.speed;
                    if(s.y > canvas.height) s.y = 0;
                });
                requestAnimationFrame(animate);
            }
            animate();

            // --- UI LOGIC ---
            function setFilter(f) {
                currentFilter = f;
                document.querySelectorAll('[id^="f-"]').forEach(b => b.classList.remove('active'));
                document.getElementById('f-' + f).classList.add('active');
                if(f === 'all') {
                    currentCodec = 'all';
                    document.getElementById('codecSelect').value = 'all';
                }
                filterAndSort();
            }

            function setCodecFilter(c) {
                currentCodec = c;
                filterAndSort();
            }

            function setSort(s) {
                currentSort = s;
                filterAndSort();
            }

            function toggleShowHidden() {
                showHidden = !showHidden;
                const btn = document.getElementById('f-hidden');
                if (showHidden) {
                    btn.classList.add('active');
                    btn.innerHTML = '<span class="material-icons">visibility</span> Archiv ausblenden';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<span class="material-icons">visibility_off</span> Archiv zeigen';
                }
                filterAndSort();
            }

            function toggleHidden(card) {
                const isHidden = card.getAttribute('data-hidden') === 'true';
                const newState = !isHidden;
                const path = card.getAttribute('data-path');
                
                card.setAttribute('data-hidden', newState);
                fetch(`http://localhost:${window.SERVER_PORT}/hide?path=` + encodeURIComponent(path) + `&state=${newState}`);
                
                const btn = card.querySelector('.hide-toggle-btn .material-icons');
                btn.innerText = newState ? 'visibility' : 'visibility_off';
                
                // If we are not showing hidden, hide it immediately with a fade
                if (!showHidden) {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                    setTimeout(() => filterAndSort(), 300);
                }
            }

            function toggleLayout() {
                currentLayout = currentLayout === 'grid' ? 'list' : 'grid';
                const grid = document.getElementById('videoGrid');
                const btn = document.getElementById('toggleView');
                
                if(currentLayout === 'list') {
                    grid.classList.add('list-view');
                    document.querySelectorAll('.video-card-container').forEach(c => c.classList.add('list-row'));
                    btn.innerHTML = '<span class="material-icons">view_module</span> Grid View';
                } else {
                    grid.classList.remove('list-view');
                    document.querySelectorAll('.video-card-container').forEach(c => c.classList.remove('list-row'));
                    btn.innerHTML = '<span class="material-icons">view_list</span> List View';
                }
            }

            // --- PREVIEW LOGIC (with Intent Delay) ---
            function handleMouseEnter(container) {
                const video = container.querySelector('video');
                container.hoverTimeout = setTimeout(() => {
                    const src = video.getAttribute('data-src');
                    if (src && !video.getAttribute('src')) {
                        video.src = src;
                        video.load(); 
                        video.play().catch(e => {
                            console.log("Preview play blocked, retrying once", e);
                            video.src = src;
                            video.play();
                        });
                    }
                }, 450); // Intent delay
            }

            function handleMouseLeave(container) {
                const video = container.querySelector('video');
                clearTimeout(container.hoverTimeout);
                video.pause();
                video.removeAttribute('src');
                video.load();
            }

            // --- LAZY RENDERING (Intersection Observer) ---
            const observerOptions = { root: null, rootMargin: '200px', threshold: 0.1 };
            const revealObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        card.style.opacity = "1";
                        card.style.transform = "translateY(0)";
                        observer.unobserve(card);
                    }
                });
            }, observerOptions);

            function initLazyLoading() {
                document.querySelectorAll('.video-card-container').forEach(card => {
                    card.style.opacity = "0";
                    card.style.transform = "translateY(20px)";
                    card.style.transition = "0.5s cubic-bezier(0.2, 1, 0.2, 1)";
                    revealObserver.observe(card);
                });
            }

            // --- CINEMA MODE ---
            function openCinema(container) {
                const card = container.closest('.video-card-container');
                const path = card.getAttribute('data-path');
                const name = card.querySelector('.file-name').innerText;
                const modal = document.getElementById('cinemaModal');
                const video = document.getElementById('cinemaVideo');
                const title = document.getElementById('cinemaTitle');

                title.innerText = name;
                video.src = `http://localhost:${window.SERVER_PORT}/stream?path=` + encodeURIComponent(path);
                modal.classList.add('active');
                video.load();
                video.play().catch(e => {
                    console.log("Playback failed, trying muted", e);
                    video.muted = true;
                    video.play();
                });
            }

            function closeCinema() {
                const modal = document.getElementById('cinemaModal');
                const video = document.getElementById('cinemaVideo');
                modal.classList.remove('active');
                video.pause();
                video.src = '';
            }

            // Closes on Escape key or clicking outside the video
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeCinema();
            });

            document.getElementById('cinemaModal').addEventListener('click', (e) => {
                if (e.target.id === 'cinemaModal') closeCinema();
            });

            // --- BATCH ACTIONS ---
            function updateBatchSelection() {
                const selected = document.querySelectorAll('.video-card-container input:checked');
                const bar = document.getElementById('batchBar');
                const count = document.getElementById('batchCount');
                
                count.innerText = selected.length;
                if(selected.length > 0) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            }

            function clearSelection() {
                document.querySelectorAll('.video-card-container input:checked').forEach(i => i.checked = false);
                updateBatchSelection();
            }

            function triggerBatchHide(state) {
                const selected = document.querySelectorAll('.video-card-container input:checked');
                const paths = Array.from(selected).map(i => i.closest('.video-card-container').getAttribute('data-path'));
                
                fetch(`http://localhost:${window.SERVER_PORT}/batch_hide?paths=` + encodeURIComponent(paths.join(',')) + `&state=${state}`);
                
                selected.forEach(i => {
                    const card = i.closest('.video-card-container');
                    card.setAttribute('data-hidden', state);
                    if (!showHidden && state) {
                        card.style.opacity = '0';
                    }
                });
                
                setTimeout(() => {
                    clearSelection();
                    filterAndSort();
                }, 300);
            }

            function triggerBatchCompress() {
                const selected = document.querySelectorAll('.video-card-container input:checked');
                const paths = Array.from(selected).map(i => i.closest('.video-card-container').getAttribute('data-path'));
                
                if(confirm(`MÃ¶chtest du ${paths.length} Videos nacheinander optimieren? Dies kann eine Weile dauern.`)) {
                    fetch(`http://localhost:${window.SERVER_PORT}/batch_compress?paths=` + encodeURIComponent(paths.join(',')));
                    alert("Batch Optimierung wurde im Terminal gestartet!");
                    clearSelection();
                }
            }

            function filterAndSort() {
                const search = document.getElementById('searchBar').value.toLowerCase();
                const grid = document.getElementById('videoGrid');
                const cards = Array.from(grid.querySelectorAll('.video-card-container'));
                let vCount = 0; let tSize = 0;

                // Dynamic Sorting Engine
                cards.sort((a, b) => {
                    if (currentSort === 'bitrate') {
                        return parseFloat(b.getAttribute('data-bitrate')) - parseFloat(a.getAttribute('data-bitrate'));
                    } else if (currentSort === 'size') {
                        return parseFloat(b.getAttribute('data-size')) - parseFloat(a.getAttribute('data-size'));
                    } else if (currentSort === 'name') {
                        const nameA = a.querySelector('.file-name').innerText.toLowerCase();
                        const nameB = b.querySelector('.file-name').innerText.toLowerCase();
                        return nameA.localeCompare(nameB);
                    }
                    return 0;
                });

                cards.forEach(card => {
                    const text = card.innerText.toLowerCase();
                    const status = card.getAttribute('data-status');
                    const codec = card.getAttribute('data-codec');
                    
                    const matchesFilter = (currentFilter === 'all' || status === currentFilter);
                    const matchesCodec = (currentCodec === 'all' || codec === currentCodec);
                    const matchesSearch = text.includes(search);
                    const isHidden = card.getAttribute('data-hidden') === 'true';
                    
                    const matches = matchesFilter && matchesCodec && matchesSearch && (showHidden || !isHidden);
                    
                    card.style.display = matches ? '' : 'none';
                    if(matches) { vCount++; tSize += parseFloat(card.getAttribute('data-size')); }
                    // Re-append to maintain sorted order in the DOM
                    grid.appendChild(card);
                });

                document.getElementById('count-total').innerText = vCount;
                if (tSize > 1024 * 1024) {
                    document.getElementById('size-total').innerText = (tSize / (1024 * 1024)).toFixed(2) + " TB";
                } else if (tSize > 1024) {
                    document.getElementById('size-total').innerText = (tSize / 1024).toFixed(2) + " GB";
                } else {
                    document.getElementById('size-total').innerText = tSize.toFixed(0) + " MB";
                }
                
                initLazyLoading();
            }
            window.onload = filterAndSort;

        </script>
    </body>
    </html>